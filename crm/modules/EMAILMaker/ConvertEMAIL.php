<?php
/*********************************************************************************
 * The content of this file is subject to the EMAIL Maker license.
 * ("License"); You may not use this file except in compliance with the License
 * The Initial Developer of the Original Code is IT-Solutions4You s.r.o.
 * Portions created by IT-Solutions4You s.r.o. are Copyright(C) IT-Solutions4You s.r.o.
 * All Rights Reserved.
 ********************************************************************************/

$memory_limit = substr(ini_get("memory_limit"), 0,-1);
if($memory_limit<256){
  ini_set("memory_limit","256M");
}

global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24;

$x0b="\141\x72\x72ay\x5f\x6b\x65\x79\x73"; $x0c="\x61\162\162\x61y\137\160\x75\x73h"; $x0d="\141\162\162\141\x79\x5fm\x65rge"; $x0e="\141rr\x61\x79\x5f\x73um"; $x0f="\143\157\x75n\164"; $x10="\144\x61\x74\x65"; $x11="\145\x78pl\157d\x65"; $x12="\x66\x69\154\x65\137\x65\170\151st\163"; $x13="\x68\x74m\x6c\x5f\x65n\164i\164\171_\x64\145co\x64\x65"; $x14="\151c\157\x6e\x76"; $x15="\x69\x6dp\154\x6f\x64e"; $x16="\151\x6e_arra\x79"; $x17="\x69s\137n\x75\155\145r\x69\x63"; $x18="m\1445"; $x19="n\1542\x62\x72"; $x1a="n\165m\142e\x72\x5f\146o\x72\x6d\141\164"; $x1b="ro\x75nd"; $x1c="st\x72_\x72\145\x70\x6c\x61\x63e"; $x1d="\163t\162\137\151rep\154ace"; $x1e="strl\145\x6e"; $x1f="\163\164r\164ol\157\167e\162"; $x20="\x73\164r\x74\157u\x70\x70\x65r"; $x21="\163\164\x72\x70o\x73"; $x22="st\x72\163t\x72"; $x23="s\x75\142\163\164\x72"; $x24="\x74\x72\x69\155"; 
class EMAILContent {private $module;private $recipient_id;private $recipient_module;private $language;private $focus;private $db;private $mod_strings;private $def_charset;private $site_url;private $decimal_point;private $thousands_separator;private $decimals;private $ignored_picklist_values=array();private $header;private $footer;private $body;private $content;private $templatename;private $type;private $replacements;private $Email_Images;private $inventory_table_array = Array("\120\x75r\x63\x68a\163\x65\117\162\x64e\x72"=>"vti\147\145\162\x5f\160\165\x72chase\x6f\162\x64\x65\162", "\123\x61\154\145\x73Ord\x65\x72"=>"vt\151\147\x65r_\163\x61\154\x65sor\144\145r", "\121\165\x6fte\x73"=>"\x76\164\x69\x67\145\162_q\x75o\x74e\163", "\111n\166oi\x63\x65"=>"\x76\x74\151g\x65\x72_\151n\x76\157i\x63e", "Issu\x65c\141\162\144s"=>"v\x74\151\x67e\x72\x5f\x69s\x73\x75\x65\x63\x61\x72d\163", "R\145\x63eip\x74\143\141r\x64\x73"=>"\166\164\x69\147\145r_\x72\145\x63e\151p\164\x63a\x72\144\x73", "\103\x72ed\x69t\x6e\x6ft\145"=>"\x76\x74ig\x65\162\137c\162\x65di\164n\157te", "\123\164o\x72\x6eo\x49nv\157\151ce"=>"\x76\164\x69ger_\163t\x6f\162n\x6fi\x6ev\x6f\x69\x63\145");private $inventory_id_array = Array("\x50\165r\143\150a\163\x65\117rd\145r"=>"\160\165\162c\x68\141\x73\145or\x64\145r\x69\144","S\141\154es\117\162d\145r"=>"\163al\x65\x73o\162\x64e\x72\x69\144","\121\x75ot\x65\163"=>"q\165ot\x65\x69d","In\166oic\x65"=>"\151nv\157\151c\145\151d","\x49ss\x75\145\x63\x61\162\x64s"=>"\151\163\x73\x75\145c\141r\144i\144","Re\143\x65\151\160\164\143\141\162d\x73"=>"\162\145c\x65\151\160\x74car\144\x69\144","C\162\145\144i\164\156\157\164\x65"=>"\143\x72\145di\x74\x6e\157te_i\x64","\x53\164orn\x6f\x49n\x76\x6f\x69\x63\145"=>"st\x6f\162n\157i\x6e\x76o\151c\145\x5f\x69d");private $org_colsOLD = array("\157\x72\x67\x61n\151\172\x61\x74\x69\157\x6en\x61\x6de" => "\x43\117\115\120\101NY\137\116A\x4d\x45","a\144\144re\x73s" => "C\x4fMP\x41\x4e\x59_\101D\x44RE\x53\x53","\143\x69\164\x79" => "\103\x4f\115\120A\116\x59_\x43I\124Y","st\141te" => "C\117M\120\101\x4eY\x5f\123TA\124\x45","\x63\x6f\144\x65" => "C\117\115\x50\101\116\131\137\x5aI\120","c\x6f\165\x6etr\171" => "\103\117\115\x50\x41N\x59\x5f\103\117U\x4eTRY","pho\156\145" => "\x43O\x4d\120\101\x4e\x59\137\x50HO\116\x45","\146\141x" => "\103\117\x4dPAN\x59\x5fF\101\x58","w\145b\x73\x69t\145" => "\x43\x4f\115\x50\101N\x59\x5f\x57\105B\123I\124E","\x6c\x6fgo" => "\103\117\115\x50\101\116\131_\114\x4f\x47\x4f", );private $org_colsNEW = array("\157r\x67\x61\x6e\x69\172a\x74\x69on\156\141\x6d\x65" => "\x63\x6f\155\160\141\156\x79\x2d\156a\155e","a\x64d\162\x65\x73\163" => "c\157m\x70\141\156y-a\x64\144r\x65\x73s","c\x69ty" => "\143\157\x6d\x70\x61\x6e\x79\055\143i\164\171","s\164\141\x74\145" => "c\x6f\155\x70an\x79\055s\164a\x74e","c\x6f\x64\145" => "\x63\x6f\x6dp\x61\156\171\x2dzi\x70","\x63\x6f\x75\156\164ry" => "c\157m\x70a\x6ey\x2dco\165n\x74\162\x79","\160h\x6f\x6ee" => "com\x70a\156\x79\x2d\160h\x6f\156\x65","fa\170" => "\143o\x6d\160a\x6ey\055\x66\x61x","\167\145b\163\x69\x74\145" => "com\160\x61\156y-w\145\142\163i\x74e","l\x6f\147\x6f" => "c\x6fmp\141n\x79-\x6cog\x6f", );function __construct() {$db = "a\x64b";$mod = "\145_m\x6fd\137st\x72i\156g\x73";$vcv = "\166tig\x65\162\137\143\165r\x72\x65n\164_\166\145r\163i\x6f\156";$salt = "\163\151\x74\145_U\x52L";$dc = "\x64\x65f\141\165\154\164\137\x63h\x61\x72\x73\x65\164"; global $$db, $$mod, $$vcv, $$salt, $$dc;$this->site_url = $$salt; $this->db = &$$db;$this->mod_strings = $$mod;$this->def_charset = $$dc;$this->type = "fre\x65";$this->language = $_SESSION['authenticated_user_language']; }public function setContent($email_body, $recipientid, $recipientmodule, $pid) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24;  $this->recipient_id = $recipientid;$this->recipient_module = $recipientmodule;$this->body = $email_body;$this->x13();if ($pid[0] == "\x6d"){if ($this->recipient_id != "" && $this->recipient_id != "0"){$pid = $this->recipient_id;}else{$pid = "";}} if ($pid != "" && $pid != "\060"){ $result = $this->db->pquery("\163e\x6c\145c\164 \x73\145\x74\171p\145 \146\x72\x6fm\040v\164ig\145r_c\162\x6d\x65\x6et\151ty \167\150e\162\x65\x20c\x72\155\151\x64\x3d\x3f", array($pid));$num_rows = $this->db->num_rows($result);if ($num_rows > 0){ $this->module = $this->db->query_result($result,0,"\x73e\164\x79\x70\145"); $this->focus = CRMEntity::getInstance($this->module);$this->focus->retrieve_entity_info($pid,$this->module); $this->focus->id = $pid;}}$sql = "SELE\103\x54\x20*\040F\122\117\x4d\x20v\x74\x69\x67\145\162\137\x65\x6da\153e\x72\x74\x65m\160l\x61\164\x65\x73\137\x73\x65ttin\147s";$result = $this->db->pquery($sql, array());$data = $this->db->fetch_array($result);$this->decimal_point = $x13($data["\144\x65\143\x69\x6d\141\154\x5f\x70\x6f\x69\156\164"], ENT_QUOTES);$this->thousands_separator = $x13(($data["\x74\150\157u\163\x61\x6e\144s\x5fse\160\x61\162\141\164\x6f\162"]!="\x73\160" ? $data["\164\150\157\165s\x61\x6ed\x73_\x73\x65p\x61r\141\164\157r"] : "\x20"), ENT_QUOTES);$this->decimals = $data["\144e\x63\151\x6da\154\x73"];$this->language = $_SESSION['authenticated_user_language']; }public function getContent($convert_recipient = true) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; require_once("cl\141s\163\x65\163\057\x73im\160\154\x65\137h\164\x6d\x6c\137\x64o\x6d\062\056\x70hp");$img_root = "\151m\147\137ro\157\x74\137d\x69r\145c\x74\157\x72y";global $$img_root;$this->content = $this->body;$this->replacements["&\156\142sp\073"]="\040";$this->replacements["\x23\x23\104\104\x2d\x4d\115\x2d\131\131Y\x59##"]=$x10("d-\155-\x59");$this->replacements["\x23\x23\x44\x44.\x4dM\x2e\131Y\131\131#\x23"]=$x10("\144\x2e\155\056Y");$this->replacements["##\115M\055DD-YYYY\043#"]=$x10("\155\x2dd-Y");$this->replacements["#\x23YY\131\131\055\x4d\115\055D\104#\043"]=$x10("\131\055\x6d\055\x64");$this->replacements["\043\043\115\115\057\104\x44\x2fY\131\131\x59##"]=$x10("m/\144/\131");$this->replacements["\043\x23\104\104\057\115\x4d\057\x59\x59\x59\x59\x23#"]=$x10("d\057\x6d\057\x59");$this->replacements["s\x72\143\x3d\x27"]="src\075'".$$img_root;if ($this->module != ""){ $this->replacements['$s-'.$x1f($this->module).'-crmid$']=$this->focus->id;if($this->module == "\x43\x6f\156ta\143\164s"){$this->replacements['$s-contacts-imagename$']=$this->x15($this->focus->id);} $this->replacements['$USERS_IMAGENAME$']=$this->x16($this->focus->column_fields["\x61s\x73\x69g\156\145\x64\x5f\165\x73\145r_\x69\144"]); $this->replacements['$R_USERS_IMAGENAME$']=$this->x16($_SESSION["\x61uthe\156t\151\x63\x61\164\145\x64\x5f\165\x73er_\151d"]); }$this->x12();$this->content = $x13($this->content,ENT_QUOTES,$this->def_charset); if ($convert_recipient && $this->recipient_id != ""){$focus_recipient = CRMEntity::getInstance($this->recipient_module);$focus_recipient->id = $this->recipient_id;$this->x1d($focus_recipient,$focus_recipient->id ,$this->recipient_module);$this->x0e($this->recipient_module, $focus_recipient);}if ($this->module != ""){$this->x0b();$this->x0e($this->module, $this->focus, "\x73-");$this->x0d("\x73",$this->module,$this->focus);if($this->focus->column_fields["\x61\x73\x73\x69\x67\x6e\145\x64\x5f\165ser_\151\144"]==""){$this->focus->column_fields["\141\x73\x73\x69\x67n\145\144\137u\163\145\162\137\151\x64"]=$this->db->query_result($this->db->query("\x53EL\105CT s\155ow\x6ee\x72\151\x64\x20\x46\x52\x4f\x4d \x76\164\x69ge\x72\137\143\x72\155en\164\x69t\x79 \127\x48\x45\x52\x45 \x63\x72m\x69\144\075".$this->focus->id),0,"\163m\x6f\x77\156\x65ri\144");}$this->x23(); }$this->x0f();$this->x10();if ($convert_recipient) $this->x11(); if($x20($this->def_charset) != "\125\124F-\x38") {$this->content = $x14($this->def_charset,"\125\x54\106\055\070//\x54RAN\123\x4c\x49\x54",$this->content);}if ($convert_recipient){$this->x24();} return $this->content;}private function x0b() { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $sql = "\x53E\x4c\x45C\124 f\151\145\154di\144\054\040\146\x69\145ld\156\x61\x6de\x2c\040c\x6f\x6c\165\x6dn\x6e\141\x6de\054 \165\151\x74\x79p\x65\x0d\012\040  \040\040\x20\040\x20\040 \x20\040\040\x20\106\x52\x4f\115 \x76\164\151ge\x72_\x66\151eld\x0d\012 \x20\040\x20 \040 \040 \x20 \x20\x20\040\127H\105R\105 t\x61\x62\151\x64\075".getTabId($this->module)."\x20\101\x4eD \050d\x69\x73\x70\x6ca\171t\x79\160\x65\040\041\x3d 3\x20O\122\040\x66ie\x6c\144\151\144\x20\075 \0664)";$result = $this->db->query($sql);$num_rows = $this->db->num_rows($result);if ($num_rows > 0){$tacModules = array();$tac4you = $x17(getTabId("\x54a\143\x34\171o\165"));if($tac4you == true) {$tacSql = "\123\x45\x4c\105\103T \164ac4\x79\157\165_\155o\x64\165\x6c\x65\x20F\x52\x4f\x4d\x20\166\x74\151\x67\x65r\137\164ac\x34\x79\x6f\x75\137m\157\x64\x75\154\145\040\x57\x48\105RE p\162\145\163\145\x6e\x63\x65\x20\x3d\040\x31";$tacResult = $this->db->query($tacSql);while($tacRow = $this->db->fetchByAssoc($tacResult))$tacModules[$tacRow["\164\x61\x63\x34\x79\x6f\x75\x5f\155\x6fd\165\154e"]] = $tacRow["\x74ac4\171\x6f\x75\137m\x6f\x64\x75\x6c\145"];} while($row = $this->db->fetch_array($result)){$columnname = $row["\143o\x6cumn\x6e\141\x6de"];$related_module = "";$fk_record = $this->focus->column_fields[$row["\146\x69eldn\141\155e"]];switch ($row["\x75it\171pe"]) {case "5\x31": $related_module = "\101\x63c\157u\156ts"; break;case "\x35\067": $related_module = "\x43o\156\x74\x61\x63\x74\x73"; break;case "5\x38": $related_module = "Ca\x6d\x70a\151\x67\156s"; break;case "5\x39": $related_module = "\120r\157d\165ct\x73"; break;case "\x373": $related_module = "A\143\x63o\165\156t\163"; break;case "\x37\065": $related_module = "\x56e\156dor\x73"; break;case "\0701": $related_module = "V\145\x6e\144\x6fr\x73"; break;case "76": $related_module = "P\x6f\164\x65\156\x74\151\141l\x73"; break;case "7\x38": $related_module = "Qu\x6f\164\x65\163"; break;case "\0700": $related_module = "\123al\x65\163\x4fr\144\x65r"; break;case "6\x38":case "\x310": $related_module = getSalesEntityType($fk_record); break;}if ($related_module != "") {$tabid = getTabId($related_module);$field_inf = "\x5f\x66i\145\x6c\x64i\x6ef\157\137ca\143h\145";$temp = &VTCacheUtils::$$field_inf;unset($temp[$tabid]); $focus2 = CRMEntity::getInstance($related_module);if ($fk_record != "" && $fk_record != "\060") {$result_delete = $this->db->query("\123\105L\105\103\x54 \x64e\x6c\145\164e\x64 \x46\x52O\115\040\166\x74\x69g\x65\162_c\x72m\145\156\x74\x69ty\x20\x57\x48E\122\105 \143\162mi\144='".$fk_record."'\040\x41\x4e\x44\x20\144\145le\x74\x65d\x3d\060");if($this->db->num_rows($result_delete)>0){ $focus2->retrieve_entity_info($fk_record,$related_module); $focus2->id = $fk_record;}}$this->replacements["\x24"."r-".$columnname."\055".$x1f($related_module)."\055\143\x72\x6d\151d\x24"]=$focus2->id; if(isset($related_module) AND $related_module == "\103\x6fnta\143t\x73"){$this->replacements['$r-'.$columnname.'-contacts-imagename$']=$this->x15($focus2->id); }if(isset($tacModules[$related_module])) {$tacSql = "\123\x45\114\105\x43T\040te\170t\x20\x46ROM v\164i\147e\162\x5f\164\x61\x634\x79\157\165_t\145\170\x74s\040\127\x48\105R\x45\040\x69\144\x3d\x3f";$tacResult = $this->db->pquery($tacSql, array($focus2->id));$tacText = $this->db->query_result($tacResult, 0, "\x74\x65\170\164");$this->replacements["\x24"."r-".$columnname."-".$x1f($related_module)."\x2d\164a\1434\x79\x6f\x75\x24"] = $x13($tacText, ENT_QUOTES, $this->def_charset);;} $this->x12();$this->x0e($related_module, $focus2, "r\x2d".$columnname."-");$this->x0d("\x72",$related_module,$focus2);unset($focus2);}if ($row["\165i\164\x79\x70\x65"] == "\x31\060" || $row["\165i\164\x79p\x65"] == "68") {$F_Related_Modules = array(); if ($row["\x75\151typ\145"] == "6\x38"){$F_Related_Modules[] = "\101\x63\x63ou\x6e\164\x73"; $F_Related_Modules[] = "C\x6f\x6e\x74\141c\164\163";}elseif ($row["\165\x69\164\x79p\145"] == "\0610"){$fm_sql = 'select relmodule from vtiger_fieldmodulerel where fieldid=?';$fmrs=$this->db->pquery($fm_sql, array($row['fieldid']));while ($rmr=$this->db->fetch_array($fmrs)) { $F_Related_Modules[] = $rmr['relmodule'];}}foreach ($F_Related_Modules AS $related_module2) {if ($related_module2 != $related_module){$tabid2 = getTabId($related_module2);$field_inf = "\137\146i\x65\154\144i\x6ef\157\x5fc\141c\x68e";$temp = &VTCacheUtils::$$field_inf;unset($temp[$tabid2]);$focus3 = CRMEntity::getInstance($related_module2);$this->replacements["\x24"."\162-".$columnname."\x2d".$x1f($related_module2)."-crm\x69\x64\x24"]=$focus3->id;$this->x0e($related_module2, $focus3, "r-".$columnname."\x2d");unset($focus3);}}}}}}private function x0c() { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; require_once("\143\x6c\141\x73se\x73/s\151\x6d\160l\145\137\150\x74m\154\x5f\144om2.php");$html = str_get_html2($this->content);foreach($html->find("\164\x64") as $td){if($x24($td->plaintext) == "\x23\x50RO\x44\125C\124\102\114OC\x5fS\x54\101\122T\x23") $td->parent->outertext = "\x23\x50ROD\x55\x43\x54B\x4c\117C_\123T\101R\x54#"; if($x24($td->plaintext) == "#\120\122O\x44\x55\x43\x54B\x4c\x4f\x43\x5f\x45N\104\043") $td->parent->outertext = "#P\122OD\x55\x43\124\x42LO\103\137EN\x44\043";}$this->content=$html->save();} private function x0d($p_type,$parent_module,$parent_focus) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24;  $query = "s\x65\x6c\145\x63\x74\x20* \x66\x72\x6f\x6d\x20\x76\x74\151g\x65\x72_\x69n\x76\x65n\x74\157\162y\x70r\157d\165\143tre\x6c w\x68\x65\162\145\x20\151\144\075?";$result = $this->db->pquery($query, array($parent_focus->id));$num_rows=$this->db->num_rows($result);if ($num_rows > 0){if (!isset($this->inventory_table_array[$parent_module]) || $this->inventory_table_array[$parent_module] == "") {$query2 = "\163\145\x6ce\143\164 \164a\142l\x65n\141m\x65,\040\145\x6et\151ty\x69df\151e\x6cd\040fr\157\155\040\166\x74\151\x67\x65r\x5f\145\x6e\164\151\164\171\156\141me \x77\x68\x65r\x65 \155o\144\x75\154\x65\156\x61\x6de\x3d\x3f"; $result2 = $this->db->pquery($query2, array($parent_module)); $this->inventory_table_array[$parent_module] = $this->db->query_result($result2,0,"\x74\x61\x62\154e\x6e\x61\155\x65"); $this->inventory_id_array[$parent_module] = $this->db->query_result($result2,0,"e\156t\x69\164y\x69\x64f\x69\x65\x6c\x64");}$currencytype = $this->x1a($parent_module,$parent_focus->id);$currencytype["c\x75r\x72\145n\143y\x5f\x73\x79\x6db\157\154"] = $x1c("â�\254","\046\145\x75ro\x3b",$currencytype["\x63\x75\162\162\x65\x6e\143\x79_s\x79mb\x6f\154"]);$currencytype["\143u\x72r\145ncy\137s\171\x6db\157\x6c"] = $x1c("\302\243","\x26\x70\x6f\165n\144;",$currencytype["\143\x75\x72rency\x5f\163\x79\155b\x6f\x6c"]);$Products = $this->x14($parent_module,$parent_focus);if ($x0f($Products["\x54O\124AL"]["\x56\x41\x54\x42L\117CK"]) > 0){$vattable = "\074t\x61b\x6c\145 \x62ord\x65r='1'\040\163tyl\145='\142\x6frde\162-co\x6c\x6c\141\160\163\145\072c\x6flla\160\163\145;' \x63\x65l\154p\141d\x64\x69\156g\075'\x33'\x3e";$vattable .= "\074\164\162\x3e\015\x0a\x20\x20\x20\x20\x20\x20 \040\x20\x20\040\x20\040\040\x20\040\040 \x20\040\x20\x20\x20\x20\040  \x20\x3c\164\144\040\156\157\167\x72\x61p \x61\x6c\x69gn='\x63\145\156\x74\145r'>".$this->app_strings["\116am\x65"]."<\057\x74\x64\076
\x20 \040\040  \x20\x20\040\x20  \040\x20\040\040\040\040\x20 \x20\x20 \040\x20   \074t\144 \156\157\x77\x72ap\040\x61l\151g\156='ce\x6e\164\145r'>".$this->mod_strings["LB\114_\126\101\124\102L\x4fC\113\x5f\x56\101\x54_\x50\105R\103\105\x4eT"]."</td>\x0d\x0a\x20\040\040\040\040\x20 \040\x20\040\x20  \x20\x20 \040\040\x20\040\040  \040\040 \x20\040<\x74\x64 \156o\167ra\x70\040\141l\x69\x67\x6e\x3d'\x63ent\145r'\076".$this->mod_strings["LBL\137\126\x41\x54B\x4c\117\x43\113\137\123\x55\115"]."\x20\050".$currencytype["c\x75\x72\x72\145\x6e\143\171_s\x79\155b\157\154"]."\x29"."<\057\x74\x64\x3e\015\x0a\040  \040 \040\040 \040\040\040 \x20  \x20\040\040\x20 \x20\040 \040 \x20\x20 \x3c\x74\x64\x20n\x6f\167\162\141\x70\040al\151gn='\143e\156\164\x65r'\x3e".$this->mod_strings["LB\114\x5f\126\101\124\102\x4c\x4fC\x4b_\x56\x41T_\126\101L\x55\x45"]."\040\x28".$currencytype["cu\162\162e\156\x63\x79\137\x73\171\x6d\142\x6f\154"]."\x29"."\074\x2f\164\144\076\x0d\012\040\x20\x20\x20\040\040\x20 \x20\x20\040  \x20\040\x20\040\x20 \040\040 \040\040\x20 <\x2f\x74\162\x3e";foreach ($Products["\x54\117T\101\x4c"]["\126A\124\102L\117CK"] as $keyW=>$valueW) {if($valueW["\x6ee\164\164o"]!=0) {$vattable .= "<\164r\076\015\x0a\x20\040   \x20\040\x20   \040\040 \x20\x20 \040\x20\040 \x20 \x20\040\x20\040  \040 \x20 \040\x20\x20\x3c\x74d\x20\x6eo\167r\141\160\x20\x61\154\151\147n\075'l\x65\x66t'\x20w\x69\x64\x74\x68\x3d'2\060%'\076".$valueW["\154a\142\145l"]."\x3c\057\x74\x64>\015
\040\x20 \x20 \040 \040\040\040\x20\x20\040\040 \040  \x20\040\x09	\x09	\074\x74\x64 \x6eo\x77\x72\x61p\040\x61\154ig\x6e='\162\x69\x67\150\x74'\x20w\x69\144t\x68\075'\x32\x35\x25'>".$this->x1c($valueW["v\141\154\x75\x65"])."\040%\x3c\x2f\x74\144>\015\012\x20\x20\040\040 \040\040\040   \040\x20\040\040\040\x20\040\x20\x20 \x20 \040\x20 \x20\x20 \040\040 \x20\040\040\040<\x74\x64 \156\157\167r\141p \141\154i\x67\156\075'\x72i\x67\x68t' \x77i\x64\x74h\075'3\x30%'\x3e".$this->x1c($valueW["\x6e\145t\164\157"])."\074/t\144>\015
 \x20\040\x20\x20  \040  \x20  \040 \040    \040 \040   \040\040 \040\040 \040   <\x74d\x20\156\157\167\x72ap \141l\151g\x6e='r\151\147\150t' wi\x64\x74\x68\075'\x325%'\076".$this->x1c($valueW["\x76at"])."\074/\164\144\076\x0d\x0a\x20\x20  \040   \x20\x20\x20\040\x20\040  \x20\040\040 \040\040 \040\040\040  \x20 \x20 \x20 \074/\164\162>";} }$vattable .= "\x3c/\164\141\142\154\x65\x3e";}else{ $vattable = "";}$this->replacements["\x24".$p_type."\055s\x75\142\164\157\x74\x61l$"] = $this->x1c($parent_focus->column_fields["\150\144\156\123\165\142T\157\x74a\x6c"]);$this->replacements["$".$p_type."\055t\157\x74\x61\x6c$"] = $this->x1c($parent_focus->column_fields["hd\x6eG\x72a\x6e\144T\x6ftal"]);$this->replacements["\044".$p_type."\055\x63u\x72\x72\145\x6e\143y\x6e\x61me$"] = getTranslatedCurrencyString($currencytype["\143\165rr\145\x6e\143y\x5fn\141\155e"]);$this->replacements["\044".$p_type."\x2d\143\x75rre\156c\x79\163\171mb\157\x6c\x24"] = $currencytype["\x63ur\162ency_\163\x79\155b\x6f\154"];$this->replacements["\044".$p_type."\x2d\143\165r\162\145\156\x63y\143\157\144e$"] = $currencytype["\143u\x72\x72e\x6e\143\171\137\143od\x65"];$this->replacements["$".$p_type."\x2d\141d\x6a\x75\x73\x74\x6d\x65n\x74$"] = $this->x1c($parent_focus->column_fields["txtA\144\152\x75\163\x74m\x65n\x74"]);$this->replacements["\x24".$p_type."-\164\157\x74\x61\154w\x69\164\150\x6f\165\164v\x61\x74"] = $Products["\x54\x4fT\x41\114"]["\124O\124\x41\114\127\111T\110\117UT\126\101T"];$this->replacements["\x24".$p_type."\055\x76\x61\164\x24"] = $Products["\124\x4fTAL"]["\x54\x41\130TO\124\101\114"];$this->replacements["\x24".$p_type."\x2d\166\x61\164\x70\145\162\x63\x65\156\x74\044"] = $Products["\x54\x4fT\101\114"]["\124\101\x58TO\124\x41\114\x50\x45\122\x43\x45\x4e\124"];$this->replacements["$".$p_type."\x2dva\x74\142\154\x6f\x63\153$"] = $vattable;$this->replacements["\044".$p_type."\055\x74ot\141\x6c\167i\x74h\166a\164\x24"] = $Products["TO\124AL"]["\124\x4f\x54\x41\x4cW\x49\x54\110\126\101\124"];$this->replacements["$".$p_type."\055\163h\x74a\170a\x6d\x6f\165n\164\x24"] = $Products["T\x4f\x54\101L"]["SH\124\101X\x41MO\x55NT"];$this->replacements["\x24".$p_type."\055\x73\150\164\x61\170t\157t\141\154\x24"] = $Products["TO\124\x41\x4c"]["SHT\101\130T\x4fT\x41\x4c"];$this->replacements["\044".$p_type."-\x74\x6ftaldis\x63o\165n\164\x24"] = $Products["TOT\101L"]["FI\116\x41LDI\x53\x43OU\116T"];$this->replacements["$".$p_type."-\164o\x74a\154d\151\163co\x75nt\x70\145r\x63\145\x6e\x74\044"] = $Products["\124\x4fTA\114"]["\106I\116\101L\104\x49\x53\x43\117U\116\x54\120\x45\122\103\105N\124"];$this->replacements["\044".$p_type."\x2d\x74\157\164a\154a\x66\x74e\162\x64\151\x73\x63\157\165\x6e\x74$"] = $Products["\124\117\124\101\114"]["\x54\117\x54\x41\x4cAF\x54E\122\x44I\123CO\125N\x54"];$this->x12();$var_array = array();if ($p_type == "\163"){$this->replacements["\044"."S\125\102\x54\x4f\124\x41\114$"] = $this->x1c($parent_focus->column_fields["h\144\x6e\123\x75b\x54\x6f\164\141\x6c"]);$this->replacements["\x24"."\x54O\124\x41\x4c$"] = $this->x1c($parent_focus->column_fields["\150d\156\x47\x72a\x6ed\x54\157\x74al"]);$this->replacements["$"."\103U\122RE\116C\131\x4eAME$"] = getTranslatedCurrencyString($currencytype["\x63\x75\162\162e\156c\x79\x5f\156\x61\155\145"]);$this->replacements["\044"."\103U\122RENC\x59S\x59\115\102\117L\x24"] = $currencytype["\x63u\x72\x72\145n\x63y_\x73y\x6d\142\x6fl"];$this->replacements["$"."\103URR\105\x4e\103\x59\103\117\104\x45\x24"] = $currencytype["c\x75\162\x72\145\x6ec\x79_\x63\157\144\145"];$this->replacements["$"."\101\x44JUS\x54\115\105NT\044"] = $this->x1c($parent_focus->column_fields["\x74x\x74\101\144\x6a\165st\x6d\x65\x6e\x74"]);$this->replacements["\x24"."\124O\x54\x41\x4c\x57\111\124\110O\x55T\126\x41\x54"] = $Products["T\117T\x41L"]["T\117\124\x41\x4c\x57\111\x54\110\x4fU\124\126\x41T"];$this->replacements["$"."\x56A\x54\x24"] = $Products["\x54OTA\114"]["\x54A\130TO\124\x41L"];$this->replacements["\044"."V\x41\x54P\105R\x43\x45\116T\044"] = $Products["\x54O\124\x41L"]["TAXT\x4fTA\x4c\x50\x45\x52\103E\116\124"];$this->replacements["\044"."V\x41\x54\x42\114\117\x43K\044"] = $vattable;$this->replacements["\044"."\124\117\124A\114\127\111\124\110VAT$"] = $Products["\x54\117\124\101\x4c"]["T\117\124\x41L\x57\x49TH\x56\101\124"];$this->replacements["$"."\123HT\x41\x58\101\x4d\117U\x4eT$"] = $Products["\x54\117\x54AL"]["S\110\124A\130\101\115O\x55\x4e\124"];$this->replacements["$"."\x53\x48TAX\124\117\124AL\044"] = $Products["\x54OT\101\x4c"]["\x53\110T\x41\x58\124\117\124\x41\114"];$this->replacements["$"."TOT\101L\104\x49\x53\103O\x55\116T\x24"] = $Products["\124\x4f\124\101L"]["\106\x49\x4e\x41\x4c\104\111SC\117\125NT"];$this->replacements["\044"."\x54O\x54A\114\x44\111\123C\x4fU\116\x54\x50ER\x43E\x4eT$"] = $Products["\124\x4f\x54\x41L"]["F\111NA\x4cD\x49\123\103OU\x4e\124\x50E\122C\105\x4e\x54"];$this->replacements["\044"."T\117\x54\101\x4c\101F\124E\122\x44\111\x53\103\117U\x4eT\044"] = $Products["\124OTA\114"]["T\117\x54\x41\x4c\x41\106\x54\x45R\x44\x49\123\103\x4f\x55N\x54"];$this->x12();if($x21($this->content,"#"."\x50\x52\x4fDU\103TB\114\x4f\x43\x5f\x53\124ART"."\043") !== false && $x21($this->content,"\043"."P\x52\x4f\x44U\103\124\102\x4c\117\103\x5f\105\x4e\104"."\x23") !== false){$this->x0c();$ExplodedPdf = array();$Exploded = $x11("#"."\120R\x4f\104\125\103\124B\114\x4fC_ST\101\122\x54"."\x23",$this->content);$ExplodedPdf[] = $Exploded[0];for($iterator=1;$iterator<$x0f($Exploded);$iterator++){$SubExploded = $x11("\x23"."\x50RO\104\x55C\x54BLO\x43_\105\116\104"."\x23",$Exploded[$iterator]);foreach($SubExploded as $part)$ExplodedPdf[] = $part;$highestpartid = $iterator*2-1;$ProductParts[$highestpartid]=$ExplodedPdf[$highestpartid];$ExplodedPdf[$highestpartid]="";} foreach ($Products["\120"] AS $Product_i => $Product_Details) {foreach($ProductParts as $productpartid=>$productparttext){foreach ($Product_Details AS $coll => $value) {$productparttext = $x1c("$".$x20($coll)."$",$value,$productparttext);$productparttext = $x1c("$".$x1f($coll)."$",$value,$productparttext);}$ExplodedPdf[$productpartid].=$productparttext;}}$this->content = $x15("",$ExplodedPdf);}}}}private function x0e($emodule, $efocus, $related = "", $is_inventory = false) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $related_fieldnames = array("r\145l\141\x74\x65d\x5ft\157","\162e\x6c\141\x74\x65\x64\x74\157","\160a\x72e\x6e\x74\x5f\151d","\x70\x61\162e\156\x74i\144","\160r\157\144\x75c\x74\x5f\151\144","p\162oduc\x74\x69d","\163\x65r\x76\151\x63\145\x5fi\x64","\163\x65\162\x76i\143\145\x69d","v\145\156\144\x6f\x72\x5f\x69d","\160\x72o\144\165c\164","\x61\143\143\157\x75n\x74","i\156\x76\x6fi\143e\151\x64","\154\x69nk\164\x6f\x61c\143\157\165\156\164\x73\143\x6f\156\164\141c\164\x73","\x70r\x6f\x6a\145\x63\164\x69d","\163c\137\x72\145\154\141\x74e\x64\137\164o");if($is_inventory)$inventory_content=array();$tabid = getTabid($emodule);$Checkboxes = array();$Picklists = array();$Textareas = array();$Datefields = array();$Multipicklists = array();$NumbersField = array();$sql = "\x53\x45\114\x45\x43\x54\x20\146\x69\x65\x6c\x64n\141\155e\054\x20ui\164y\160\x65 \106\122\117M\x20\166\x74ige\162\137f\151\145\154\x64\x20\127\110E\x52\105\040t\x61\142\x69\144\x20= '".$tabid."'";$result = $this->db->query($sql);while($row = $this->db->fetchByAssoc($result)){if ($row["uity\x70\145"] == "\x319" || $row["\x75i\164\171pe"] == "\062\060" || $row["ui\x74yp\145"] == "\x321" || $row["\165\151\x74\171\x70\x65"] == "\x32\x34")$Textareas[] = $row["f\x69\x65l\144\x6ea\155\145"];elseif ($row["\165it\x79\x70e"] == "\x35" || $row["\165it\171\160e"] == "\062\063" || $row["\x75i\x74\171p\x65"] == "\067\x30")$Datefields[] = $row["\x66\x69\145\x6c\x64n\x61\155\x65"];elseif ($row["\x75i\164yp\145"] == "\061\x35" || $row["\x66\151\x65\154\x64\156ame"] == "\x73\x61\154\x75\164\141\164\151\x6f\x6et\171\x70e")$Picklists[] = $row["f\151\x65l\144\x6e\x61m\x65"];elseif ($row["\165i\164yp\x65"] == "5\066")$Checkboxes[] = $row["\146i\x65\154\x64\156\x61\x6de"];elseif ($row["\165\x69\164y\160e"] == "\x33\x33")$Multipicklists[] = $row["\x66i\145\x6c\144\x6eam\x65"];elseif ($row["\165\151t\x79pe"] == "\067\x31")$NumbersField[] = $row["fie\154d\x6e\141\x6d\x65"];}foreach ($efocus->column_fields as $fieldname => $value){if ($fieldname == "\141\x73\x73\151\x67\x6ee\x64\x5f\x75\x73\x65r\x5fi\x64")$value = $this->x17($value);elseif($fieldname == "\x61c\x63o\x75n\164\x5fi\x64") { $value = getAccountName($value);}elseif($fieldname == "\x70\x6ft\x65\156\164\151\x61\154\137\x69\144")$value = getPotentialName($value);elseif($fieldname == "\143\157\156\164\x61\x63\164\x5f\x69d")$value = getContactName($value);elseif($fieldname == "\x71\x75\x6f\164\145\x5f\x69\x64")$value = getQuoteName($value);elseif($fieldname == "\163a\x6c\145\x73o\162\144\145\x72_i\144")$value = getSoName($value);elseif($fieldname == "campa\x69\x67n\x69\x64")$value = getCampaignName($value);elseif($fieldname == "t\145\162\x6ds\x5f\143o\156\144i\x74i\157\156s")$value = $this->x1e($value);elseif($fieldname == "\x63\x6fmm\x65n\164\x73")$value = $this->x1f($efocus);elseif($fieldname == "\146\x6f\154\x64e\162id")$value = $this->x20($value);elseif($x16($fieldname, $related_fieldnames)) {if ($value != "") {$parent_module = getSalesEntityType($value);$displayValueArray = getEntityName($parent_module, $value);if(!empty($displayValueArray)) {foreach($displayValueArray as $key=>$p_value) {$value = $p_value;}}if($fieldname=="\151\x6e\x76o\x69\143\145\151\x64" && $value=="\x30")$value="";}}if($x16($fieldname, $Datefields))$value = getValidDisplayDate($value);elseif($x16($fieldname, $Picklists)) {if(!$x16($x24($value), $this->ignored_picklist_values))$value = $this->x19($value,$emodule);else$value = "";}elseif($x16($fieldname, $Checkboxes)) {$email_app_strings = return_application_language($this->language);if($value == 1)$value = $email_app_strings["\171es"];else$value = $email_app_strings["\156\x6f"];} elseif($x16($fieldname, $Textareas)) {$value = $x19($value); $value = $x13($value,ENT_QUOTES,$this->def_charset);} elseif($x16($fieldname, $Multipicklists)) $value = $x1d(' |##| ',', ',$value);elseif($x16($fieldname, $NumbersField))$value = $this->x1c($value); if ($is_inventory)$inventory_content[$x1f($emodule."\055".$fieldname)] = $value;else$this->replacements["$".$related.$x1f($emodule."\x2d".$fieldname)."\044"]=$value;} if($is_inventory)return $inventory_content;else$this->x12();}private function x0f() { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $cur_usr = "\x63u\162\162\x65\x6e\x74\x5f\165\x73\x65\x72";$root_dir = "\162\157ot_\x64\151\162\145c\164o\x72\171";global $$cur_usr,$$root_dir; $sql = "S\x45L\x45\103\124\040\x2a\040\106R\117\115 \x76t\151\147\145\162_\157r\147\x61n\151\x7a\141ti\157nd\145\164\x61\151\x6cs";$result = $this->db->query($sql);$Org_Details = $this->db->fetchByAssoc($result, 1);foreach ($Org_Details AS $coll => $value) {if ($coll == "l\157\147o")$value = "<i\155\147 s\162\143\x3d'".$$root_dir."\164\x65\x73\x74\057\x6c\x6fg\157\x2f".$Org_Details["\x6c\157\x67\157\156a\155\145"]."'>";$this->replacements["$".$this->org_colsOLD[$coll]."$"] = $value;$this->replacements["\044".$this->org_colsNEW[$coll]."$"] = $value;} $sql = "\123\x45\114\105\103\x54\x20\x74\141n\144c\x20\x46R\x4fM\040\x76\x74\x69\x67\x65r_\x69\156v\145\156\164\x6f\162\x79_t\141\156\144\x63 \127\x48E\122E\040\164y\160\x65\040\075\040'\x49\x6e\166\x65\x6e\x74ory'";$tandc = $this->db->query_result($this->db->query($sql), 0, "\164a\x6ed\x63");$this->replacements["$"."\164\x65\162ms-a\x6e\x64\x2d\x63\x6f\x6e\x64i\x74\151\157\x6e\163$"] = $x19($tandc);$this->x12();if ($this->module != ""){$focus_user = CRMEntity::getInstance("Use\162s");$focus_user->id = $this->focus->column_fields["a\x73si\x67\x6e\145\x64_us\145\162\x5f\x69d"];$this->x1d($focus_user,$focus_user->id ,"U\163\145\x72\163");$this->x0e("\x55s\x65\162\163", $focus_user, "\x73\055");}$this->x0e("Use\162\x73", $$cur_usr, "l-");}private function x10(){ global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24;  $app_lang = return_application_language($this->language);if($x21($this->content, "\045\107\x5f")!==false){ foreach($app_lang as $key=>$value){ $this->replacements["\045G\x5f".$key."\045"] = $value; } }if ($this->module != "") { $mod_lang = return_specified_module_language($this->language,$this->module); if($x21($this->content, "\045M\137")!==false){ foreach($mod_lang as $key=>$value){ $this->replacements["\045\x4d\x5f".$key."\045"] = $value; } } } $this->x12();}private function x11(){ global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $salt = "\x73it\145\137\x55R\114"; global $$salt;$surl = $$salt; require_once("c\154a\163\x73\145s\x2f\x73\151\155ple_h\164\x6d\x6c\137d\x6f\155\x32\056\x70\150\x70");$html = str_get_html2($this->content);if($surl[$x1e($surl) - 1] != "/")$surl = $surl."/";$i = 1;foreach($html->find("\x69\x6dg") as $img){if($x21($img->src, $surl) === 0) {$newPath = $x1c($surl, "", $img->src);if($x12($newPath)){$img->src = "ci\x64:\x69\155\141\147e".$i;$Parts = $x11(".",$newPath);$img_type = $Parts[$x0f($Parts) - 1];$this->Email_Images["\151\155\x61\x67e".$i] = array("\x6e\x61\155\x65"=>"\151\155\x61g\145".$i."\x2e".$img_type,"\160\x61\x74\150"=> $newPath);$i++; }}}foreach($html->find('[background]') as $img){if($x21($img->background, $surl) === 0) {$newPath = $x1c($surl, "", $img->background);if($x12($newPath)){$img->background = "\143\x69\x64\072\x69\155\141\x67\x65".$i;$Parts = $x11(".",$newPath);$img_type = $Parts[$x0f($Parts) - 1];$this->Email_Images["\151m\x61\147\x65".$i] = array("\x6e\x61\x6d\x65"=>"\x69\x6d\141g\145".$i.".".$img_type,"\x70\141\x74h"=> $newPath);$i++; }}}$this->content=$html->save();}public function getEmailImages($convert_recipient = true) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; return $this->Email_Images;}private function x12() { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; if(!empty($this->replacements)){ $this->content = $x1c($x0b($this->replacements), $this->replacements, $this->content);$this->replacements = array();}}private function x13() { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $sql = "\x53\x45LE\103T\x20\x76\141l\165\145\x20F\122\x4f\x4d\040\166\x74i\147\145r\137emak\x65\162\164\x65m\x70\154a\x74es_ig\x6e\x6f\162\x65\160\151c\x6bl\x69st\166a\154\x75es";$result = $this->db->query($sql);while($row = $this->db->fetchByAssoc($result)) {$this->ignored_picklist_values[] = $row["\166al\165\145"];}}private function x14($parent_module,$parent_focus) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $taxtype = $this->x1b($parent_module,$parent_focus->id);$currencytype = $this->x1a($parent_module,$parent_focus->id);$query="s\145\x6ce\143t\x20\143\x61\x73e\x20w\x68e\x6e\x20v\x74\x69\147e\x72_\x70\x72\157\144\165\143\x74\163\056p\x72od\x75\x63ti\144 \041\075\x20''\040th\145\156\x20\x76\164\x69\x67\x65\x72_\x70\x72\x6f\144u\x63ts\056\x70\162o\x64\x75c\164\156\x61\155\x65\040\x65\x6cs\x65\x20vti\x67\x65r\x5f\x73\x65\x72\x76\151\143\x65.\x73\145r\166\x69\143\145\x6e\x61me\040\145nd\040as\040p\x72\157\x64uct\156\x61\x6d\145\x2c" ." \143\141\163e \167\x68e\156\x20\x76\x74ige\162\x5f\x70rod\165c\164\x73\x2ep\x72od\165c\x74\151\144\040\041\x3d ''\x20t\150\x65n\040\x76\x74\151\x67\x65\162\x5fp\162od\165\143ts\x2e\x70r\157\144\x75\x63t\x69\x64\x20\145\154\163\145\040v\x74\x69\147\145r_\x73\x65\x72vi\x63e.s\145\162\166\x69\x63\145i\x64 \145\x6e\144 \x61s \160\x73id," ."\x20c\141se \x77\150e\x6e\x20vt\151\x67\x65\162\x5fp\x72o\144\x75c\x74s.p\x72\157\x64\x75\143tid\x20\041\075 '' \x74\150e\x6e\040vt\151\147\x65\x72\x5fp\162oduc\164\163\x2e\160\x72\157\x64u\x63\164_\156\157 \x65\x6cse\x20\166\x74\151\x67\145\x72_\x73e\x72v\151\143\145\056s\145r\x76\151\143e\137\x6e\x6f\040\145\156\x64\x20\x61s\040\160s\x6e\157\054" ."\x20\143\x61\163e \x77\150\x65\156\x20\x76\x74\151\x67\145r\x5f\x70\x72\x6f\x64\x75\x63ts.\x70\x72\x6fd\165\143tid !\x3d ''\x20\164\150e\156 '\120ro\x64\x75\143ts' \x65\154s\x65\040'\123\145\x72\166\151\x63\x65\x73'\040en\144 \x61s\040\x65\x6eti\x74\x79t\x79\160e," ."\040c\141\163e\040\x77\x68e\156 \166tige\162\137\160\162\x6f\144u\143\164\x73\x2e\x70\162\157\x64\x75\x63\x74\x69\x64\040!=\x20''\x20\164\x68\x65\156\040vtig\x65r\137\x70\162\x6fdu\x63\x74s\x2e\165n\151\x74\x5f\x70r\x69\143\x65\x20\x65l\163e \x76t\x69\147\x65\162_\163erv\x69c\x65\056\165nit_p\162ic\x65 \x65\156\144\040\141\x73\x20\x75\x6e\x69\164\137\x70\162\x69\143\145\x2c" ."\x20c\x61\x73\x65\040\167\x68\x65\156 \x76\164i\147\x65r\137pro\x64\165\143\164\163\x2e\160\x72\x6f\x64uc\x74i\144 \x21\075 '' \164\150\145\x6e \x76t\x69\147\145r\x5f\x70\x72o\x64u\143\164s\056\x75s\x61g\145\x75\x6e\x69\x74 \x65ls\145\x20vt\x69g\x65\162\137\x73e\x72\166\151\143e.\163\145r\x76\151\143e_\165s\x61\147\x65\165\156i\x74 \145nd \141\163\040u\163\x61\147\145\x75\x6ei\164\054" ."\x20c\141\163\x65\x20w\150\145n \x76\164\x69\x67\x65r_\160\x72\157\x64uc\164\163.\x70r\x6fd\x75c\164\x69\144 !\x3d\040'' th\145\156\040vti\x67e\162_p\162o\144\165\143t\x73.\161\164y_p\x65r_\165\156\x69t\x20e\x6cse\040v\x74i\147\145\162_s\145\x72\166\x69c\145\056q\x74\171\137p\x65\162\x5f\x75\156i\x74 \145\156\144\x20a\163\040q\x74\171\137p\x65\162\137u\x6e\151\164\x2c" ."\x20c\x61s\x65 w\150\145\156\x20vti\147\x65\x72\x5fpr\157\x64\165\x63\164s.\160\162o\x64u\x63t\151\144\x20!\x3d ''\040th\x65n\040\166\x74\x69\x67er\x5fprod\x75\143t\x73\x2e\161ty\x69\x6es\164\x6fck\x20else '\x4e\101'\x20e\156d\040\141\163\x20q\164\171in\163\164\157\143\x6b," ."\x20\143\141\163\145\040\x77h\145\x6e \x76\x74\x69\147\145r_\x70\162\157d\x75c\x74\x73.pro\x64\x75ct\151\x64 != ''\x20t\x68e\156\x20\x63\061\056\144\145\x73\x63r\x69p\164\151o\x6e e\x6c\x73e\x20\143\062\056d\x65\163\143r\151\160\164i\157\156\040e\x6e\x64\040as\x20\x70s\144e\163c\162\151\x70t\x69\157\156\x2c \166\x74i\147\145\162\x5f\151nv\x65\156\x74\157\162y\160\162\x6f\144u\143\164\x72e\154\x2e\052 " ." \x66\x72\x6f\x6d\x20\166tiger\137\x69nv\145\156tory\160ro\x64\165\143\164\x72e\x6c" ." l\145\x66\164\x20\x6a\157in \166tig\x65r\x5fp\x72\x6f\144\x75\x63\x74\x73\x20on\040\x76\164i\x67\145\162_p\x72\157\144\165c\x74\163\056\x70\x72\157\144u\143\x74i\144=v\164ig\145\162\x5fi\x6e\166e\156t\157\x72y\160\162o\x64uc\x74\162\145\x6c\056\160\x72\x6fd\165\143\x74i\144\040" ."\040l\x65f\164\040\x6a\x6f\151n\x20\x76\x74\x69\147\145r\x5f\x63r\x6d\x65n\164\x69ty\040a\163\x20\x631\040\157\156\040c1\056c\162\155\151\x64 \x3d\x20\166\164\x69\x67\x65\x72\x5fpr\x6f\144\165\x63\x74s\x2e\160\x72o\x64\x75\143\x74\x69\x64\x20" ." \x6c\x65ft\x20\x6aoi\156\040\166\164\151\x67\145\162_\x73\145\162v\151c\145\040\157\x6e\x20\166\164\x69g\x65\162\x5fs\x65\x72v\151c\145\056s\x65\x72\x76i\143ei\x64=\166\164\151\x67\145\162\x5fi\156\166e\156\164\x6f\162\x79p\162\157\x64\x75c\164\x72e\x6c\056\x70\x72\x6fdu\x63\164\x69\144\040" ." l\x65\146\164\x20joi\156\x20\166\164i\x67\145\x72\137\x63rmen\164i\x74y\040a\x73 c\x32 \x6f\156 \x63\x32\056\143r\155\x69d \075 \x76\x74\x69ger_ser\x76\x69\143e.\x73e\x72\x76\151\143\145i\144\x20" ."\040w\150\145r\x65\040id\075\x3f\x20\117\122D\x45\x52\x20BY\x20\163\145\x71u\x65\x6e\x63e\x5f\x6eo";$result = $this->db->pquery($query, array($parent_focus->id));$num_rows=$this->db->num_rows($result);$netTotal = "\060\056\060\x30"; $totalAfterDiscount_subtotal=0;$total_subtotal=0;$totalsum_subtotal=0; $Total_Tax_Values = array();for($i=1;$i<=$num_rows;$i++){$sub_prod_query = $this->db->pquery("S\105\x4cE\x43\x54\040\160\162od\165\143t\151\144 fro\x6d\x20v\x74i\147\x65\x72_\151\x6ev\x65\x6etor\x79su\142\x70r\x6f\144\x75\143\164re\x6c\040\127\x48\105RE\040i\x64\075\x3f \101\x4eD\x20\163\145q\165en\143\145_\156o\x3d\077",array($parent_focus->id,$i));$subprodname_str='';if($this->db->num_rows($sub_prod_query)>0){for($j=0;$j<$this->db->num_rows($sub_prod_query);$j++){$sprod_id = $this->db->query_result($sub_prod_query,$j,"pro\x64\165\x63\x74i\144");$sprod_name = getProductName($sprod_id);$str_sep = "";if($j>0) $str_sep = "\x3a";$subprodname_str .= $str_sep."\x20\x2d ".$sprod_name;}}$subprodname_str = $x1c("\072","\x3c\142\162\076",$subprodname_str);$psid = $this->db->query_result($result,$i-1,"\160s\x69\x64");$psno = $this->db->query_result($result,$i-1,"\160s\x6e\x6f");$productid=$this->db->query_result($result,$i-1,"\160\x72\157d\165\x63\x74i\144");$entitytype=$this->db->query_result($result,$i-1,"\145\156\x74\x69\164y\164\171\x70e");$producttitle = $productname= $this->db->query_result($result,$i-1,"\x70\x72\x6f\144uc\x74n\141\155\x65");if($subprodname_str!="") $productname .= "\074\x62\162\057\x3e\x3c\x73\160\141n\x20s\x74y\x6c\145\075'c\x6f\x6c\157\x72\x3a\043\x43\060\x430\x43\060;\146o\x6e\164-\x73\x74yl\x65:\151\x74a\x6ci\x63\073'\x3e".$subprodname_str."\074\x2f\163p\x61\x6e>";$comment=$this->db->query_result($result,$i-1,"\143\x6f\155men\164");$psdescription =$this->db->query_result($result,$i-1,"\x70\163\144e\x73c\162\x69\160\x74\x69on");$inventory_prodrel_desc = $this->db->query_result($result,$i-1,"\144es\x63\162\x69\160\x74i\x6f\x6e");$qtyinstock=$this->db->query_result($result,$i-1,"\x71\x74\x79i\x6e\163\x74o\143\x6b");$qty=$this->db->query_result($result,$i-1,"\161\165\141n\164\151\164\x79");$qty_per_unit=$this->db->query_result($result,$i-1,"\161\x74\171\137p\145\x72\x5fu\156\x69t");$usageunit=$this->db->query_result($result,$i-1,"\x75\x73a\147\145\x75\x6ei\x74");$unitprice=$this->db->query_result($result,$i-1,"u\156i\x74\137p\x72ic\x65");$listprice=$this->db->query_result($result,$i-1,"list\x70\162\151c\x65");$total = $qty*$listprice; $discount_percent=$this->db->query_result($result,$i-1,"\144\x69s\x63o\x75\x6e\x74\137\160\x65r\143\145nt");$discount_amount=$this->db->query_result($result,$i-1,"\x64\151\x73\x63\157\x75\156\x74_\x61m\x6f\165\x6e\164");$totalAfterDiscount = $total;$productDiscount = "0.\x30\060";$productDiscountPercent = "";if($discount_percent != "N\125L\114" && $discount_percent != "") {$productDiscount = $total*$discount_percent/100;$totalAfterDiscount = $total-$productDiscount; $productDiscountPercent=$discount_percent;}elseif($discount_amount != "\x4e\125L\x4c" && $discount_amount != "") {$productDiscount = $discount_amount;$totalAfterDiscount = $total-$productDiscount;} $netprice = $totalAfterDiscount; if($taxtype == "\x69\156\x64ivi\144u\x61\154") {$taxtotal = "\060.\x30\x30";$tax_info_message = $this->mod_strings["\x4c\102L\x5fTO\x54\x41\114\137A\106\x54\x45R\137\x44IS\x43OU\116\x54"]."\040=\x20$totalAfterDiscount \\n";$tax_details = getTaxDetailsForProduct($productid,"\x61\x6c\154");$Tax_Values = array();for($tax_count=0;$tax_count<$x0f($tax_details);$tax_count++) {$tax_name = $tax_details[$tax_count]["\164\141x\156\x61me"];$tax_label = $tax_details[$tax_count]["\x74\x61x\x6c\141b\x65\154"];$tax_value = getInventoryProductTaxValue($parent_focus->id, $productid, $tax_name);$individual_taxamount = $totalAfterDiscount*$tax_value/100;$taxtotal = $taxtotal + $individual_taxamount;if ($tax_name != "" && $tax_value > 0){ $vatblock[$tax_name."\x2d".$tax_value]["l\141\x62e\154"] = $tax_label;$vatblock[$tax_name."\055".$tax_value]["\156\x65\x74t\157"] += $totalAfterDiscount; $vatblock[$tax_name."\055".$tax_value]["\x76at"] += $x1b($individual_taxamount,$this->decimals);$vatblock[$tax_name."\055".$tax_value]["\x76\141\x6c\165\145"] = $tax_value;$x0c($Tax_Values, $tax_value);$x0c($Total_Tax_Values, $tax_value);}$netprice = $netprice + $taxtotal;} if ($x0f($Tax_Values) > 0){ $tax_avg_value = $x0e($Tax_Values);}else{ $tax_avg_value = "0\056\060\060";} $Details["\x50"][$i]["\120RO\x44U\103TV\x41\124\120\x45\x52\103ENT"] = $this->x1c($tax_avg_value);$Details["\120"][$i]["PR\117D\125CTV\101\x54\123\x55M"] = $this->x1c($taxtotal);}if ($entitytype == "P\162o\x64\x75\x63\x74\163"){ $Details["\x50"][$i]["\120R\117\x44U\103\124\123\x5f\103\x52M\x49\104"] = $psid; $Details["\x50"][$i]["S\x45RV\111CE\x53\137\103\122\x4d\x49\x44"] = "";}else{ $Details["P"][$i]["\x50\122O\104U\x43\x54S_CRM\x49\x44"] = ""; $Details["\x50"][$i]["\x53E\122\126\111\103ES\137\103R\115\111\104"] = $psid;}$Details["\120"][$i]["\120\123_\x43R\115\111\x44"] = $psid;$Details["\x50"][$i]["\x50\x53\137\x4eO"] = $psno;if($comment!=""){$comment = $x1c("\\n", "<b\162\076", $x19($comment)); $comment = $x13($comment,ENT_QUOTES,$this->def_charset);$productname .= "\x3c\142r\x20/\076\074s\155\141l\154>".$comment."\074\057\x73\155\141\154\x6c\x3e";}$Details["P"][$i]["\120\x52O\104\125C\x54N\x41ME"] = $productname;$Details["P"][$i]["PRO\104\x55\103T\124I\x54\x4cE"] = $producttitle;$psdescription = $x1c("\\\x6e", "<\142\162\x3e", $x19($psdescription));$Details["\120"][$i]["P\x52\x4f\x44\x55C\x54\x44E\123\x43\122\111P\x54\111\117\116"] = $x13($psdescription,ENT_QUOTES,$this->def_charset);$Details["\x50"][$i]["\120R\x4fD\125C\124\105\x44I\124D\x45SC\x52\x49P\124\111O\116"] = $comment;$inventory_prodrel_desc = $x1c("\\n", "\x3c\x62\162>", $x19($inventory_prodrel_desc)); $Details["\x50"][$i]["\x43RMN\117WP\122\x4fDUC\124\x44\105S\x43RI\120\124\x49O\x4e"] = $x13($inventory_prodrel_desc,ENT_QUOTES,$this->def_charset);$Details["P"][$i]["\120\122\117\104U\103T\114\x49\123\124\x50R\x49CE"] = $this->x1c($listprice);$Details["\120"][$i]["\120RO\104\x55C\124\x54O\x54\101L"] = $this->x1c($total);$Details["\x50"][$i]["P\x52\117\104\125\x43\x54Q\x55\x41N\124\111\124\131"] = $this->x1c($qty);$Details["\x50"][$i]["PR\117\x44\x55C\124\121I\116\123\124O\103\x4b"] = $this->x1c($qtyinstock); $Details["P"][$i]["\x50\122\x4f\x44\x55C\x54PR\x49\103\x45"] = $this->x1c($unitprice); $Details["\120"][$i]["PR\x4f\104\125C\124PO\x53I\124IO\x4e"] = $i;$Details["\x50"][$i]["P\x52O\104\x55C\x54\121\124Y\120\105\x52\125N\111\124"] = $this->x1c($qty_per_unit); $Details["P"][$i]["P\122\117\x44\x55\103\x54\125\x53A\107E\125N\111\124"] = $this->x19($usageunit,"\x50\x72\x6f\144\x75\143\x74\x73\x2f\x53\145\162\x76\151ce\x73");$Details["\120"][$i]["P\x52\117\104\x55C\x54DIS\x43O\x55\116T"] = $this->x1c($productDiscount);$Details["\x50"][$i]["\120\122\x4f\x44\125\103\124DISC\x4f\x55\116TPERCE\x4e\x54"] = $this->x1c($productDiscountPercent);$Details["\x50"][$i]["\120R\x4f\x44U\103\124\123T\117\124\101\114\101\x46\124\105\x52\104I\123\x43O\125NTS\125M"] = $totalAfterDiscount; $Details["\x50"][$i]["\120\x52\x4f\104\x55\x43\124S\124\117\124A\x4c\x41F\124E\x52D\x49\x53\103\x4f\125NT"] = $this->x1c($totalAfterDiscount);$Details["P"][$i]["PR\x4f\x44\125\x43\x54\x54O\x54A\x4c\123U\115"] = $this->x1c($totalAfterDiscount+$taxtotal); $totalAfterDiscount_subtotal += $totalAfterDiscount;$total_subtotal += $total;$totalsum_subtotal+= $totalAfterDiscount+$taxtotal;$Details["\120"][$i]["\x50\122\117DU\x43\124\x53\124\x4f\124A\114\x41\106\x54E\122D\x49SCO\x55\x4eT_\x53\x55\x42\x54O\x54AL"] = $this->x1c($totalAfterDiscount_subtotal);$Details["\x50"][$i]["\120\x52\x4f\x44\125C\x54T\x4f\x54\x41L\137\x53UB\124\117T\101\114"] = $this->x1c($total_subtotal);$Details["P"][$i]["\120\122O\104UCT\x54OTA\x4c\x53\125\x4d\137\x53\x55\x42T\117\124\x41L"] = $this->x1c($totalsum_subtotal); $sequence = $this->db->query_result($result,$i-1,"s\145\161u\145\156\x63e\x5f\x6e\x6f");$Details["\120"][$i]["\120RO\x44\125\103\124S\x45\121U\x45\x4e\x43\x45"] = $sequence;if(isset($images[$productid."\x5f".$sequence])){$width="";$height="";if($images[$productid."\137".$sequence]["\x77i\x64\x74h"]>0)$width=" w\151d\x74\x68='".$images[$productid."\137".$sequence]["\167\151\144t\150"]."' ";if($images[$productid."_".$sequence]["\x68e\151\147\150t"]>0)$height=" \150e\x69g\x68\x74\x3d'".$images[$productid."\137".$sequence]["\x68e\x69\x67\150t"]."' ";$Details["\120"][$i]["\x50\122O\x44\125C\124\123\x5f\111\x4d\101\x47\105\116\x41\115\105"] = "<\151\x6dg\x20\163\162\143\x3d'".$this->site_url."\057".$images[$productid."_".$sequence]["\163\162\143"]."'\040".$width.$height."\x2f>";} $focus_p = CRMEntity::getInstance("\120\162\157\x64\x75\143\164\163");if ($entitytype == "\x50\x72\x6f\144\x75c\x74\x73" && $psid != "") {$focus_p->id = $psid;$this->x1d($focus_p,$psid,"\x50\162o\x64\x75\143t\163"); }$Array_P = $this->x0e("\x50\162\x6f\144u\x63ts", $focus_p, "\163-", true);$Details["\120"][$i] = $x0d($Array_P,$Details["P"][$i]);unset($focus_p);$focus_s = CRMEntity::getInstance("S\145\162v\151\143e\163");if ($entitytype == "\x53\145\x72\x76ice\x73" && $psid != "") {$focus_s->id = $psid;$this->x1d($focus_s,$psid,"S\x65\162\166\151ces"); }$Array_S = $this->x0e("\123e\162v\151\x63\145s", $focus_s, "\163\055", true);$Details["P"][$i] = $x0d($Array_S,$Details["\x50"][$i]);unset($focus_s); $sumwithoutvat += $totalAfterDiscount;$netTotal = $netTotal + $netprice;} $finalDiscount = "\060\056\0600";$final_discount_info = "\060";$finalDiscountPercent=""; if($parent_focus->column_fields["\150d\156\x44\x69\x73c\157\x75nt\120\x65\162c\x65\x6e\x74"] != "0") {$finalDiscount = ($netTotal*$parent_focus->column_fields["\150\x64\156D\151\163c\157\165\x6e\x74P\x65\x72c\x65n\x74"]/100);$finalDiscountPercent = $parent_focus->column_fields["h\x64nD\x69\x73cou\156\164\120\145\162\x63\145\156\164"];}elseif($parent_focus->column_fields["\150\144\x6e\104\x69sc\x6fu\x6e\164A\x6d\157\165\156\164"] != "\060") {$finalDiscount = $parent_focus->column_fields["\x68\144nD\151s\x63\x6f\165\156\x74\x41m\157\165\x6et"];} $taxtotal = "\060\x2e\x300";if($taxtype == "g\x72\x6f\x75\160") {$final_totalAfterDiscount = $netTotal - $finalDiscount;$tax_details = getAllTaxes("\141\166ailab\154\145","","\145di\164",$parent_focus->id);for($tax_count=0;$tax_count<$x0f($tax_details);$tax_count++) {$tax_name = $tax_details[$tax_count]["\164\141x\156\141m\x65"];$tax_label = $tax_details[$tax_count]["\164\x61\170\x6c\141\142\145l"];$tax_value = $this->db->query_result($result,0,$tax_name);if($tax_value == "" || $tax_value == "NULL")$tax_value = "0.\x30\x30";$taxamount = ($netTotal-$finalDiscount)*$tax_value/100;$taxtotal = $taxtotal + $taxamount;if ($tax_name != "" && $tax_value > 0){ $vatblock[$tax_name]["\x6c\141\x62\x65\154"] = $tax_label;$vatblock[$tax_name]["\156e\164\164o"] = $final_totalAfterDiscount; $vatblock[$tax_name]["\x76\x61\x74"] += $taxamount; $vatblock[$tax_name]["\166\141lu\145"] = $tax_value; } $total_vat_percent += $tax_value;}$vat_value = $taxtotal; foreach ($Details["\x50"] as $keyP=>$valueP) {$productvatsum = ($Details["\x50"][$keyP]["\120\122\117DU\x43T\123\124\117\x54\101\114\x41\106\x54E\x52\x44I\123COUN\x54\123\125\115"]*$total_vat_percent)/100;$producttotalsum = $Details["\x50"][$keyP]["P\122O\x44\125\103\124\x53TO\124\x41L\101\106T\x45\122\104\111\x53COU\x4e\124\123\125\x4d"] + $productvatsum;$Details["\120"][$keyP]["\120\122\117D\x55\103\x54\x56\x41T\120\105\122\x43\105N\124"] = $this->x1c($total_vat_percent);$Details["\x50"][$keyP]["PR\117\104\125CTV\x41\x54\123UM"] = $this->x1c($productvatsum);$Details["\120"][$keyP]["\120\x52\x4f\104\x55\103TT\117TALS\125\115"] = $this->x1c($producttotalsum);} }else {if ($x0f($vatblock) > 0){ foreach ($vatblock as $keyM => $valueM) $vat_value += $valueM["v\141\x74"];}else{ $vat_value = "\060\05600"; }} $shAmount = ($parent_focus->column_fields["\x68\144n\123_\110\x5fAmo\x75\x6e\x74"] != "")?$parent_focus->column_fields["\x68\144n\123\x5f\110\x5fA\155o\165\156\x74"]:"\060\05600";$shtaxtotal = "0\056\060\x30";$shtax_details = getAllTaxes("\141\x76\x61\x69la\142le","\163\x68","\145d\151t",$parent_focus->id);for($shtax_count=0;$shtax_count<$x0f($shtax_details);$shtax_count++) {$shtax_name = $shtax_details[$shtax_count]["\164\141\170\156a\x6d\145"];$shtax_label = $shtax_details[$shtax_count]["t\141\x78\154\x61\x62el"];$shtax_percent = getInventorySHTaxPercent($parent_id,$shtax_name);$shtaxamount = $shAmount*$shtax_percent/100;$shtaxtotal = $shtaxtotal + $shtaxamount;}$totalafterdiscount = $sumwithoutvat-$finalDiscount;$totalwithvat = ($sumwithoutvat-$finalDiscount)+$vat_value;$Details["T\x4fT\101\x4c"]["\116\105T\x54\x4fT\x41L"] = $this->x1c($netTotal);$Details["T\x4fTAL"]["\124\x4fT\101LWI\124\110\x4f\125\124V\x41T"] = $this->x1c($sumwithoutvat);$Details["\124O\124A\x4c"]["\x46\111\x4eA\x4cD\111\123COU\x4eT"] = $this->x1c($finalDiscount);$Details["\x54\117\124A\x4c"]["\x46\111\x4eA\x4c\104\111\x53\x43\117\125\116\x54P\x45R\x43\x45NT"] = $this->x1c($finalDiscountPercent);$Details["\x54\117T\101\x4c"]["\x54\x4f\x54\x41\x4cA\x46TE\x52D\111S\x43OU\x4e\x54"] = $this->x1c($totalafterdiscount);$Details["T\117TAL"]["T\x41X\124\117\124\x41L"] = $this->x1c($vat_value);$Details["\x54\117\x54A\114"]["T\x41\x58T\117T\x41\x4c\120E\122\x43E\116\124"] = $this->x1c($total_vat_percent); $Details["T\x4fT\101\114"]["T\117\124AL\127IT\x48\126A\x54"] = $this->x1c($totalwithvat);$Details["\124OTA\114"]["\123H\x54A\130\101M\117U\x4e\x54"] = $this->x1c($shAmount);$Details["\x54\x4f\124\101L"]["\x53\110T\x41\130TO\124\x41L"] = $this->x1c($shtaxtotal);$Details["\124\117\124A\114"]["\126A\124\102\x4cOC\113"] = $vatblock;return $Details;}private function x15($id){ global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; if(isset($id) AND $id!=""){$query="\123\105\x4c\x45C\x54\x20\166t\151\x67\145r\137\141tt\141\x63\x68\x6den\x74s\x2e\x70\x61\x74h\054\040v\x74\x69\x67\145\162\x5f\141\164\164a\143\x68\155e\156ts.\156\141m\145\x2c\x20v\x74i\x67e\x72\x5f\x61\x74\164\141ch\155\x65\156\164\163\x2e\141t\164\x61\143\150\155\145\156\164\x73\151\x64
\x0a\040 \040 \x20\x20\x20  \x20\040\x20 \x20F\122OM\040v\164\x69\x67\145\x72\x5f\143\x6f\156\x74\141ct\x64\145\164\x61i\154\x73
\012\x20\040 \x20\040\040\040  \x20\x20  \x20\x49\116\116\x45\122 \112\x4fI\x4e \166\164i\147\145\162\x5f\163\x65\141\x74\164ach\x6d\x65n\x74sr\145\x6c\x0d
\x20\x20\x20\040\x20   \040\x20\x20 \040\040\x20\040\x4f\x4e \x76\x74ig\x65\162\x5f\x63\157n\x74ac\x74\144\145\164\x61\151\x6cs\056\143\x6fn\x74\x61\x63\x74\x69d=\x76\164\x69\x67e\162_s\145\x61\164\x74\x61ch\x6de\156t\163r\x65\154\x2e\x63\162mi\x64\015\x0a\x20   \040 \x20 \x20 \040\040\x20 \111\116\x4e\105R \x4a\x4fIN \x76\164\x69\x67er\x5fa\164\164\x61\x63hmen\164\x73
\x0a\x20\040\040\x20\040\x20\040\040  \040\x20   \040\117N\x20v\164\151\x67\145\x72_\141\x74\x74a\143\x68\155e\156ts\056a\x74\164\x61\x63\150\x6d\x65\156\164\163\151\x64\075v\x74ig\x65\162\137s\145\141tt\141\x63\x68\155\145\x6e\164\x73\162el\056\x61\164\164\141\143\150\155e\x6e\164\x73\151\144\x0d
\040\040\040\040\040\040\x20\x20\040\040\x20\x20\x20 \x49\116\x4eER\x20\112\x4f\x49\116\x20\x76\x74\x69\x67e\x72\x5fcrm\145n\x74it\x79\015\012\040\040\040\x20\040 \040 \040\x20 \x20 \x20\x20\040\x4fN\040\166\x74\151ge\162\137a\164t\141\x63\150\155e\x6e\x74\163.\141\164t\141c\150me\156t\163i\144=vtige\x72\x5f\x63r\155\x65ntit\171.\x63r\x6d\x69\144\015\012\040  \040 \x20\x20 \x20\x20 \040 \040W\110\105R\105\x20\144\x65\154e\x74\145\144\075\060\x20\x41\116\x44\x20vti\x67\x65\162\137\x63\157\156tac\164d\x65\164a\x69l\x73\056\x63\x6f\156t\x61\143\x74\x69d\x3d?";$result = $this->db->pquery($query, array($id));$num_rows = $this->db->num_rows($result);if ($num_rows > 0){$image_src = $this->db->query_result($result,0,"pat\x68").$this->db->query_result($result,0,"\x61\x74t\x61c\x68\x6den\164s\151\144")."_".$this->db->query_result($result,0,"n\x61m\145");$image = "<\x69\155g s\x72c='".$this->site_url."\057".$image_src."'\x2f>";return $image;}} else {return "";}}private function x16($id){ global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; if(isset($id) AND $id!=""){$sql = "\x73\145l\145c\x74 \x76t\x69ger\x5f\141\x74ta\x63\150\x6d\x65\x6et\163\x2e* \x66r\157m v\x74\151g\x65r_\141t\x74\141\143\x68\x6d\145nt\163\x20le\x66t\040j\x6f\x69\156 \x76t\x69\147e\x72_sale\x73\x6dan\141\164\x74\x61\143\x68\x6d\145n\164\x73\x72\145l\x20\157\156\040\166\x74\151\x67e\x72\x5f\163a\154\145sm\x61\156\x61\x74\164\141c\x68\x6den\x74\x73\x72e\x6c\056\141\164t\141\143h\x6d\145\x6e\164\163\151\144\x20\x3d\x20\x76\164\151g\145\x72\x5fa\x74\x74\141c\x68\155\x65\156\164s\056a\x74\x74\x61c\x68\155ent\x73id wh\145r\145 \x76\164\151\x67\x65\162\x5f\163a\154es\155\141\x6ea\x74\164\141\143\150\x6d\x65\x6ets\x72\145\154.s\155i\x64=\077";$image_res = $this->db->pquery($sql, array($id));$image_id = $this->db->query_result($image_res, 0, 'attachmentsid');$image_path = $this->db->query_result($image_res, 0, 'path');$image_name = $this->db->query_result($image_res, 0, 'name');$imgpath = $image_path . $image_id . "\x5f" . $image_name;if ($image_name != '') {$image = '<img src="' . $imgpath . '" width="250px" border="0">';} else { $image = '';}return $image;} else {return "";}} private function x17($id) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; if($id != "") {$sql = "S\x45\114\105\103T\x20\x75\x73\145\162_nam\x65\040\106\122O\115\x20\166tig\145\162_\165\163ers \127\110\x45RE\040id=?";$result = $this->db->pquery($sql, array($id));$ownername = $this->db->query_result($result,0,"u\x73e\x72\x5f\x6e\141me");}if($ownername == "") {$sql = "S\x45L\105C\124\040\x67r\157\165pn\141\x6de FR\x4f\115 \166t\x69g\x65\162_\x67r\157up\x73\x20\127\x48\105R\x45\040\147\162\x6fup\151d=\x3f";$result = $this->db->pquery($sql, array($id));$ownername = $this->db->query_result($result,0,"\147\162\157\x75p\156am\x65");}else {$ownername = getUserFullName($id);}return $ownername;}private function x18($account_id) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $accountno = "";if($account_id != '') {$sql = "\123\x45L\105\103\124\x20a\x63cou\156\x74\x5f\156\x6f\x20\106\x52\117\x4d\040\166t\151ge\x72\x5f\x61\143\143\157u\x6e\x74\040W\x48\105R\105 \141\143\143\157\165\156\x74\151\144\075?";$result = $this->db->pquery($sql, array($account_id));$accountno = $this->db->query_result($result,0,"\x61\143\143\157unt_\156\x6f");}return $accountno;}private function x19($str,$emodule) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; if($emodule!="Pr\157\144\165\x63\164\163\x2f\x53\x65rv\151\143\145\x73") {$app_lang = return_application_language($this->language);$mod_lang = return_specified_module_language($this->language,$emodule);}else {$app_lang = return_specified_module_language($this->language,"S\x65\162\x76\151\x63\145s");$mod_lang = return_specified_module_language($this->language,"\x50\x72o\x64\165c\x74\163");}$trans_str = ($mod_lang[$str] != '') ? $mod_lang[$str] : (($app_lang[$str] != '') ? $app_lang[$str] : $str);return $trans_str;}private function x1a($parent_module,$parent_id) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24;  $inventory_table = $this->inventory_table_array[$parent_module];$inventory_id = $this->inventory_id_array[$parent_module];$res = $this->db->pquery("S\x45\114\105\x43T\x20\143\x75\x72renc\171\x5f\151d\x2c\x20".$inventory_table."\x2e\x63o\x6ev\x65\162s\x69\157\156\x5f\162\141t\x65\x20\x41S co\x6ev_\x72\141\x74\x65, \x76t\151\147\x65r\x5f\x63\165r\162\145n\x63\171\x5fin\x66\157.\x2a
\x0a\x20  \040\x20      \040\040   \x20 \040\x20\040   \040 \040\x46\x52\x4f\x4d\x20".$inventory_table."
 \040\x20\040\x20 \040\040\x20\x20\040\040\040  \x20\040\x20\x20  \040  \x20\040\x20\x49N\x4eE\122\040\x4a\117I\x4e\x20v\x74\x69g\x65\x72_\143ur\x72\x65n\143\171_in\146\x6f O\116\040".$inventory_table."\x2e\143\x75\x72\x72\x65nc\171_i\x64\040=\x20v\164i\147e\162_\143\165\x72\162\x65\x6e\143\171\137\x69\x6ef\x6f\x2e\151\144\015
\040\040  \x20\040\040  \x20\040 \040\x20 \x20 \x20 \x20\040\040\x20  \x20\x20\127\x48\105\122\105\040".$inventory_id."=\077", array($parent_id));$currency_info = array();$currency_info["\143u\x72\x72en\x63\x79\x5fid"] = $this->db->query_result($res,0,"\143\x75\x72\162\x65n\143\x79_\x69\144");$currency_info["\x63\x6f\x6e\x76\x65\x72\163i\x6fn_ra\x74\x65"] = $this->db->query_result($res,0,"\143o\x6e\166\x5f\162at\145");$currency_info["cu\x72r\145\156\143y_\x6e\x61\x6d\145"] = $this->db->query_result($res,0,"\143\165\162\x72\x65nc\x79\x5f\x6eam\145");$currency_info["\x63u\162\162\x65\156\143y\x5f\143\x6f\144\x65"] = $this->db->query_result($res,0,"c\x75\x72\x72\145\156\x63\x79\137cod\x65");$currency_info["cu\162\x72\145n\143\171_s\x79mbo\x6c"] = $this->db->query_result($res,0,"\x63urr\145\x6ec\171_sy\155\142\x6f\154");return $currency_info;}private function x1b($parent_module,$parent_id) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $res = $this->db->pquery("\x53E\114\105C\124 \x74a\170t\171pe\x20\x46\122\117M\x20".$this->inventory_table_array[$parent_module]." \127\110\x45\x52\105\040".$this->inventory_id_array[$parent_module]."\x3d\077", array($parent_id));$taxtype = $this->db->query_result($res,0,'taxtype');return $taxtype;}private function x1c($value) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; if($x17($value)){$number = $x1a($value,$this->decimals,$this->decimal_point,$this->thousands_separator);}else {$number = "";}return $number;}private function x1d(&$focus,$record,$module) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $result = Array();foreach($focus->tab_name_index as $table_name=>$index)$result[$table_name] = $this->db->pquery("\x53\105\x4c\x45\x43T \052\040\x46\122OM\x20".$table_name." \127\x48E\122E ".$index."\x3d\x3f", array($record));$tabid = getTabid($module);$sql1 = "S\105\114\105\103T\040\146\x69e\154\x64\x6ea\155\145\x2c\040fi\x65\154\x64id\054\x20fi\145\154dl\141\142\x65l\x2c\040c\157\154\x75\x6dn\156\141\x6de, t\x61\142\x6c\145\x6e\141\x6d\145, \x75it\171pe,\x20\164yp\x65\x6ffd\141\x74\141,\x20\x70\162\x65\x73en\143\145
 \x20\x20\x20\040\040 \x20\x20 \040\040\x20\040\040\x46\122\117M \166ti\147\145\162_\146\x69\x65l\144 \x57\x48ER\x45\x20\x74\141\x62\x69\144=\077";$result1 = $this->db->pquery($sql1, array($tabid));$noofrows = $this->db->num_rows($result1);if($noofrows) {while($resultrow = $this->db->fetch_array($result1)) {$fieldcolname = $resultrow["\x63\x6f\x6cum\x6e\156\141\155e"];$tablename= $resultrow["\x74\141bl\x65n\141\155\145"];$fieldname= $resultrow["\146\x69\x65l\x64n\x61\155\145"];$fld_value="";if(isset($result[$tablename]))$fld_value = $this->db->query_result($result[$tablename],0,$fieldcolname);$focus->column_fields[$fieldname] = $fld_value;}}$focus->column_fields["r\x65\x63\x6f\162d_id"] = $record;$focus->column_fields["r\x65\x63\x6f\162d\137m\x6fd\x75l\x65"] = $module;}private function x1e($value) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; if($x12("\x6d\157d\x75\154e\x73\x2f\x53e\164\x74\151ngs/E\x64\x69\164\x54\x65\162\x6dD\x65t\141i\154\163.\x70\150\x70")) {$sql = "S\105\114E\x43\x54\040\x74\141\156d\x63\x20FR\117\x4d\040v\164\x69ger_i\x6ev\x65\x6e\x74\157\x72\x79_\x74andc\040W\110E\x52\105\040i\144\075'".$value."'";$res = $this->db->query($sql);$num = $this->db->num_rows($res);if($num>0)$tandc = $this->db->query_result($res,0,"\x74\x61\156dc");else$tandc = $value;}else$tandc = $value;return $tandc;}private function x1f($efocus) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $commentlist="";$prefix="";if($efocus->column_fields["r\x65\143or\x64\x5f\x6do\144\x75\154\145"] == "\110\x65l\160D\x65\x73\153"){$prefix="t\151\x63\x6be\164";}elseif($efocus->column_fields["\162\145\143\157\162\x64\137\x6d\157du\154e"] == "\x46\141\161") {$prefix="\x66\141\x71";}if($prefix!="") {$mod_lang = return_specified_module_language($this->language,$efocus->column_fields["\x72\145\143o\x72\144_m\x6fd\x75l\145"]);$sql="\x53\x45\114\105\103T *\x20\x46RO\x4d \166t\x69\x67e\x72\x5f".$prefix."\x63\x6f\155\x6d\x65nt\x73 W\110\x45R\x45\040".$prefix."i\x64\x3d".$efocus->id;$result=$this->db->query($sql);while($row = $this->db->fetchByAssoc($result)) {$comment = $row["c\157m\155\145\x6e\164s"];$crtime = getValidDisplayDate($row["\x63r\145\141\x74\x65\144ti\x6d\x65"]);$body="";if($prefix=="t\151ck\145\x74"){$author = $this->x17($row["o\x77\156\x65r\x69d"]);$body=$comment."<br \057\x3e".$mod_lang["L\x42L\137\x41\125T\110OR"]."\072\040".$author."\x3c\142r\040\x2f\x3e".$mod_lang["\x43r\x65at\145\x64\x20\x54\151\155\x65"].":\x20".$crtime."\074b\162\x20/\076\074\142\162 \x2f>";}else {$body=$comment."\074b\x72\040/\076".$mod_lang["C\162\x65\x61\x74\145d \124\x69\x6d\145"].":\040".$crtime."\074\142r\040\x2f>\x3cb\162 \x2f>";}$commentlist.=$body;}}return $commentlist;}private function x20($folderid) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $sql="\123\105LEC\124\040fo\x6c\x64\x65\162n\141\x6d\x65\x20F\122\117M\x20v\x74\x69\x67\145\162\137\141t\164a\x63\150m\x65\x6et\x73\146\x6f\154\x64\x65r\x20\127\110\x45R\105\x20\x66o\154d\145\x72\x69d\x3d".$folderid;return $foldername = $this->db->query_result($this->db->query($sql),0,"\146\x6f\x6cde\x72\x6e\x61\155e");} private function x21($val){ global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $Params = array();$end = false;do {if ($x22($val, '|')) { if ($val[0] == '"'){$delimiter = '"|'; $val = $x23($val, 1); } elseif ($x23($val,0,6) == '&quot;'){$delimiter = '&quot;|'; $val = $x23($val, 6); } else$delimiter = '|';list($Params[],$val) = $x11($delimiter,$val,2);}else{ $Params[] = $val; $end = true;}} while (!$end);return $Params;}private function x22($val) { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; return $x18($val);} private function x23() { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; require_once("c\154\x61s\163es\x2f\163\x69\155\160l\145_h\x74\x6d\x6c_\144om\062\056p\x68\160");$html = str_get_html2($this->content);foreach($html->find("t\144") as $td){if($x24($td->plaintext) == "\043\x4cI\x53\x54\126\x49\105\127BLO\x43K\x5f\123T\x41R\124\043") $td->parent->outertext = "\x23\x4c\111\123\124\x56\x49\x45\x57\102\x4c\x4f\x43\x4b\137\x53\x54\101\122\x54#";if($x24($td->plaintext) == "\x23\114I\x53\x54\x56\x49EW\x42\114\x4f\x43\x4b_E\x4e\104\043") $td->parent->outertext = "\x23\x4c\x49\123\124\x56\x49\x45WB\x4cO\x43\x4b\137\x45\x4e\x44\x23";}$this->content=$html->save();} private function x24() { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24; $Clear_Modules = array("\x41c\x63oun\x74\x73","C\x6f\156t\x61\x63t\x73","Ve\156\144o\x72s","\x4ce\141d\163","\x55se\x72\163");foreach ($Clear_Modules AS $clear_module){$tabid1 = getTabId($clear_module);$field_inf = "_\x66\x69el\x64\151\x6e\x66\x6f_\x63\141\x63\x68e";$temp = &VTCacheUtils::$$field_inf;unset($temp[$tabid1]);$focus1 = CRMEntity::getInstance($clear_module);$this->replacements["\x24".$clear_module."\055\x63\x72\155\151\x64\x24"]="";$this->replacements["\044"."\163-".$clear_module."-\x63\x72\155\x69\x64$"]="";$this->x0e($clear_module, $focus1, "");$this->x0e($clear_module, $focus1, "\163\055");unset($focus1);}}public function control() { global $x0b,$x0c,$x0d,$x0e,$x0f,$x10,$x11,$x12,$x13,$x14,$x15,$x16,$x17,$x18,$x19,$x1a,$x1b,$x1c,$x1d,$x1e,$x1f,$x20,$x21,$x22,$x23,$x24;  if ($this->type == "\151\x6e\166\x61\154\x69\x64") {return false; } else {return true;}}}

function getEMAILContent($description, $id, $parent_type, $pid = '')
{
    global $adb,$log;

	$token_data_pair = explode('$',$description);
	global $current_user;
 	$emailTemplate = new EmailTemplate($parent_type, $description, $id, $current_user);
 	$description = $emailTemplate->getProcessedDescription();
 	$templateVariablePair = explode('$',$description);
 	$tokenDataPair = explode('$',$description);
	$fields = Array();
	for($i=1;$i < count($token_data_pair);$i+=2)
	{

		$module = explode('-',$tokenDataPair[$i]);
		$fields[$module[0]][] = $module[1];
	}
    if(is_array($fields['custom']) && count($fields['custom']) > 0){
    //Puneeth : Added for custom date & time fields
    $description = getMergedDescriptionCustomVars($fields, $description);
    }
    $log->debug("Exiting from getMergedDescription ...");
	return $description;
}
?>